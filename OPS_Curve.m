%define x to be strain
e = [0.2,0.60,(2/3),1000,0.114*2*5.48e-3]; %
t_OPS = {@(x)4*(1-x(1))*(1-sqrt(1-x(1)))/x(4),...
     @(x)(4*(1-x(1))*(1-sqrt(1-x(1)))/x(4))+(2*(1-x(1))/x(4)*(sqrt((1-x(1))/(1-x(2)))-1)),...
     @(x)(4*(1-x(1))*(1-sqrt(1-x(1)))/x(4))+(2*(1-x(1))/x(4)*(sqrt((1-x(1))/(1-x(2)))-1))+(2*(1/sqrt(1-x(3))-1/sqrt(1-x(2)))*(1-x(1))^(3/2)/((1-0.5)*x(4)))};

t_Trad = {@(x) 2.*x(1)./x(4),... %114.2 microsec - end e_z=0.2
     @(x) 2.*x(1)./x(4) + (x(2)-x(1))./x(4),...%190.4 microsec - end e_z=0.46655
     @(x) 2.*x(1)./x(4) + (x(2)-x(1))./x(4) + 2.*(x(3)-x(2))./x(4)}; %304.6 microsec  - end e_z=0.664

%Using cubic form 
% v_OPS = {@(x)(e(5)/2)*(2*e(4)/(2*(1-e(1))^(3/2)))*(3*(x./t_OPS{1}(e)).^2-2*(x./t_OPS{1}(e)).^3)./...
%     (1+(t_OPS{1}(e)*(e(4)/(2*(1-e(1))^(3/2)))*((x./t_OPS{1}(e)).^3-0.5*(x./t_OPS{1}(e)).^4))).^3,...
% ...
% @(x)(e(5)/2)*(2*e(4)/(2*(1-e(1))^(3/2)))./...
%     ((1-e(1))^(-1/2)+(x-t_OPS{1}(e)).*(e(4)/(2*(1-e(1))^(3/2)))).^3,...
% ...
% @(x)(e(5)/2)*(2*e(4)/(2*(1-e(1))^(3/2)))*(1-(3*((x-t_OPS{2}(e))/(t_OPS{3}(e)-t_OPS{2}(e))).^2-2*((x-t_OPS{2}(e))/(t_OPS{3}(e)-t_OPS{2}(e))).^3)) ./...
%       ((1-e(2))^(-1/2)+(e(4)/(2*(1-e(1))^(3/2)))*(x-t_OPS{2}(e)-(t_OPS{3}(e)-t_OPS{2}(e))*(((x-t_OPS{2}(e))/(t_OPS{3}(e)-t_OPS{2}(e))).^3-0.5*((x-t_OPS{2}(e))/(t_OPS{3}(e)-t_OPS{2}(e))).^4))).^3};

%Using quintic form
v_OPS = {@(x)(e(5)/2)*(2*e(4)/(2*(1-e(1))^(3/2)))*(10*(x./t_OPS{1}(e)).^3-15*(x./t_OPS{1}(e)).^4+6*(x./t_OPS{1}(e)).^5)./...
    (1+(t_OPS{1}(e)*(e(4)/(2*(1-e(1))^(3/2)))*((5/2)*(x./t_OPS{1}(e)).^4-3*(x./t_OPS{1}(e)).^5+(x./t_OPS{1}(e)).^6))).^3,...
...
@(x)(e(5)/2)*(2*e(4)/(2*(1-e(1))^(3/2)))./...
    ((1-e(1))^(-1/2)+(x-t_OPS{1}(e)).*(e(4)/(2*(1-e(1))^(3/2)))).^3,...
...
@(x)(e(5)/2)*(2*e(4)/(2*(1-e(1))^(3/2)))*(1-(10*((x-t_OPS{2}(e))/(t_OPS{3}(e)-t_OPS{2}(e))).^3-15*((x-t_OPS{2}(e))/(t_OPS{3}(e)-t_OPS{2}(e))).^4+6*((x-t_OPS{2}(e))/(t_OPS{3}(e)-t_OPS{2}(e))).^5)) ./...
      ((1-e(2))^(-1/2)+(e(4)/(2*(1-e(1))^(3/2)))*(x-t_OPS{2}(e)-(t_OPS{3}(e)-t_OPS{2}(e))*((5/2)*((x-t_OPS{2}(e))/(t_OPS{3}(e)-t_OPS{2}(e))).^3-3*((x-t_OPS{2}(e))/(t_OPS{3}(e)-t_OPS{2}(e))).^5+((x-t_OPS{2}(e))/(t_OPS{3}(e)-t_OPS{2}(e))).^6))).^3};

%Using quintic form
v_Trad = {@(x) (1/2)*e(4)*e(5)*(10*x.^3-15*x.^4+6*x.^5),...
          @(x) (1/2)*e(4)*e(5),...
          @(x) (1/2)*e(4)*e(5)*(1-(10*x.^3-15*x.^4+6*x.^5))};

ts = 0:0.5e-6:max(t_Trad{3}(e), t_OPS{3}(e));
%plot(ts,(ts<=t{1}(e)).*v{1}(ts<=t{1}(e))+(ts>t{1}(e) & ts<=t{2}(e)).*v{2}(ts<=t{2}(e))+(ts>t{2}(e) & ts<=t{3}(e)).*v{3}(ts<=t{3}(e))+(ts>t{3}(e)).*0)
%plot(ax1,ts,[v_OPS{1}(ts(ts<=t_OPS{1}(e))),v_OPS{2}(ts(ts>t_OPS{1}(e) & ts<=t_OPS{2}(e))),v_OPS{3}(ts(ts>t_OPS{2}(e) & ts<=t_OPS{3}(e))),zeros([length(ts(ts>t_OPS{3}(e))),1])'])
%hold on
%plot(ax1,ts, [v_Trad{1}((ts(ts<=t_Trad{1}(e)))/(t_Trad{1}(e))),v_Trad{2}(e).*ones([1 length(ts(ts>t_Trad{1}(e) & ts<=t_Trad{2}(e)))]), v_Trad{3}(((ts(ts>t_Trad{2}(e) & ts<=t_Trad{3}(e)))-t_Trad{2}(e))/(t_Trad{3}(e)-t_Trad{2}(e))),zeros([length(ts(ts>t_Trad{3}(e))),1])'])
% plot(ts(ts<=t{1}(e)),v{1}(ts(ts<=t{1}(e))),...
%      ts(ts>t{1}(e) & ts<=t{2}(e)),v{2}(ts(ts>t{1}(e) & ts<=t{2}(e))),...
%      ts(ts>t{2}(e) & ts<=t{3}(e)),v{3}(ts(ts>t{2}(e) & ts<=t{3}(e))),...
%      ts(ts>t{3}(e)), zeros(length(ts(ts>t{3}(e))),1))
OPS_output = [ ts(1:length(ts(ts<=t_OPS{3}(e))))', [v_OPS{1}(ts(ts<=t_OPS{1}(e))),v_OPS{2}(ts(ts>t_OPS{1}(e) & ts<=t_OPS{2}(e))),v_OPS{3}(ts(ts>t_OPS{2}(e) & ts<=t_OPS{3}(e)))]'];
Trad_output = [ ts(1:length(ts(ts<=t_Trad{3}(e))))', [v_Trad{1}((ts(ts<=t_Trad{1}(e)))/(t_Trad{1}(e))),v_Trad{2}(e).*ones([1 length(ts(ts>t_Trad{1}(e) & ts<=t_Trad{2}(e)))]),v_Trad{3}(((ts(ts>t_Trad{2}(e) & ts<=t_Trad{3}(e)))-t_Trad{2}(e))/(t_Trad{3}(e)-t_Trad{2}(e)))]'];
OPS_e_output = [OPS_output(:,1), 2/e(5)*OPS_output(:,2)];
%%
%fig1=figure;
%ax1=axes;
%plot(ax1,Trad_output(:,1),Trad_output(:,2),'-b')
%hold on
%plot(ax1,OPS_output(:,1),OPS_output(:,2),'-r')

%figure;
%plot(OPS_e_output(:,1),OPS_e_output(:,2))
%title(strcat('Optimal Pulse Shape: Nominal Axial Strain Rate, $\dot{e}_z=$',num2str(e(4))),'interpreter','latex')
%dlmwrite(strcat('OPS_',num2str(e(4))),OPS_e_output,',');
